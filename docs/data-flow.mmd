flowchart TD
    %% Data Source & Event Generation
    Start([ğŸ¬ System Start]) --> LoadTree{ğŸ”„ Load Latest<br/>Semantic Tree?}
    LoadTree -->|First Run| EmptyGraph[ğŸ†• Create Empty<br/>In-Memory Graph]
    LoadTree -->|Has Previous Data| LoadGraph[ğŸ“Š Load Tree v.N<br/>from PostgreSQL]
    
    EmptyGraph --> Ready[âœ… System Ready<br/>Concierge Agent Active]
    LoadGraph --> Ready
    
    %% Event Simulation Flow
    Ready --> SimStart[ğŸª Event Simulator<br/>Parse pineapple.json]
    SimStart --> EventStream[ğŸ“¤ Stream Message Events<br/>Real-time Simulation]
    
    %% Accumulation Phase
    EventStream --> AccumCheck{ğŸŒŠ Accumulator Raft<br/>Check Threshold}
    AccumCheck -->|Count < 100| RedisStore["ğŸ”´ Store in Redis<br/>group:X:messages<br/>group:X:count"]
    AccumCheck -->|Count >= 100| BatchReady[ğŸ“¦ Batch Ready<br/>100 Messages]
    
    RedisStore --> WaitMore["â³ Wait for More<br/>Messages"]
    WaitMore --> EventStream
    
    %% Concierge Processing Pipeline
    BatchReady --> Validate["ğŸ­ Concierge Agent<br/>ğŸ” Input Validation"]
    Validate --> NoiseFilter["ğŸ§¹ Noise Filtering<br/>Empty/Commands/Links"]
    NoiseFilter --> ContextRetrieval["ğŸ¤ Relationship Context<br/>Retrieval for User Pairs"]
    
    %% Sequential Processing Phase
    ContextRetrieval --> SpamDetect["ğŸš« Spam Detection<br/>Sequential Processing"]
    SpamDetect -->|Clean Messages| EmojiProcess["ğŸ˜€ Emoji Processing<br/>Sequential Processing"]
    EmojiProcess --> TopicMatch["ğŸ·ï¸ Topic Matching<br/>In-Memory (70% threshold)"]
    
    %% Parallel Processing Phase
    TopicMatch --> ParallelStart["ğŸ”„ Start Parallel<br/>Processing"]
    
    ParallelStart --> EmbedGen["ğŸ“Š Embedding Generation<br/>Semantic Vectors"]
    ParallelStart --> SentAnalysis["ğŸ˜Š Contextual Sentiment<br/>With Relationship Context"]
    ParallelStart --> ToxicCheck["â˜ ï¸ Toxicity Analysis<br/>Harm Detection"]
    ParallelStart --> RelUpdate["ğŸ¤ Relationship Updates<br/>User Dynamics"]
    
    %% Topic Assignment
    TopicMatch -->|No Match| TopicCreate["ğŸ§  LLM Agent<br/>Create New Topic"]
    TopicMatch -->|Match Found| TopicAssign["ğŸ·ï¸ Assign to<br/>Existing Topic"]
    TopicCreate --> TopicAssign
    
    %% Convergence & Graph Updates
    EmbedGen --> Converge["ğŸ¯ Converge Results"]
    SentAnalysis --> Converge
    ToxicCheck --> Converge
    RelUpdate --> Converge
    TopicAssign --> Converge
    
    %% In-Memory Graph Updates
    Converge --> GraphUpdate["ğŸ“Š Update In-Memory Graph<br/>Messages, Users, Topics,<br/>Relationships, Context Windows"]
    
    GraphUpdate --> ConvUpdate["ğŸ’¬ Conversation Context<br/>Update Windows (10 msgs)"]
    ConvUpdate --> RelGraphUpdate["ğŸ¤ Relationship Graph<br/>Strength, Type, Patterns"]
    RelGraphUpdate --> IndexUpdate["ğŸ” Update Search Indexes<br/>Fast Lookups"]
    
    %% Storage Decision
    IndexUpdate --> StorageDecision["ğŸ’¾ Storage Needed?"]
    StorageDecision -->|Batch Complete| StorageRaft["ğŸ’¾ Storage Raft<br/>Persist to PostgreSQL"]
    StorageDecision -->|Continue Processing| NextBatch["ğŸ“¦ Ready for Next Batch"]
    
    StorageRaft --> DBStore["ğŸ˜ PostgreSQL<br/>Store Messages/Relationships"]
    DBStore --> NextBatch
    
    %% Enhanced Event-Driven Version Control
    NextBatch --> VersionCheck["ğŸ“Š Version Control<br/>Time for Storage? (1000 msgs)"]
    VersionCheck -->|Not Yet| WaitEvents["â³ Wait for Events"]
    VersionCheck -->|Yes| EmitStorageEvent["ğŸ“¤ Concierge Agent<br/>Emit Storage Event<br/>+ Tree Payload"]
    
    EmitStorageEvent --> StorageEvent["ğŸ¯ Storage Raft<br/>Receive Tree Payload"]
    StorageEvent --> UnoptimizedStore["ğŸ˜ PostgreSQL<br/>Store Unoptimized v.N+1<br/>version_type: 'unoptimized'"]
    
    %% Event-Driven Background Optimization
    EmitStorageEvent --> OptimizationCheck["ğŸ”„ Optimization Check<br/>Every Hour?"]
    OptimizationCheck -->|Not Time| WaitEvents
    OptimizationCheck -->|Time for Optimization| EmitBGEvent["ğŸ“¤ Concierge Agent<br/>Emit Background Event<br/>+ Tree Payload"]
    
    EmitBGEvent --> BGReceive["ğŸ¯ Background Agent<br/>Receive Tree Payload"]
    WaitEvents --> EventStream
    
    %% Background Processing with Received Tree
    BGReceive --> ChatGPTFilter["ğŸ¤– ChatGPT Filtering<br/>Topic Optimization<br/>Using Received Tree"]
    ChatGPTFilter --> GraphOptimize["ğŸ”§ Graph Optimization<br/>Merge Topics, Clean Data"]
    GraphOptimize --> VersionCreate["ğŸ“ Create New Version<br/>Tree Blob + Metadata"]
    VersionCreate --> EmitOptimizedEvent["ğŸ“¤ Background Agent<br/>Emit Storage Event<br/>+ Optimized Tree Payload"]
    EmitOptimizedEvent --> OptStorageRaft["ğŸ¯ Storage Raft<br/>Receive Optimized Tree"]
    OptStorageRaft --> VersionStore["ğŸ˜ Store Optimized Tree<br/>version_type: 'optimized'<br/>version_id + 1"]
    VersionStore --> VersionSignal["ğŸ”” Signal Concierge<br/>New Version Available"]
    
    %% Version Reload
    VersionSignal --> ReloadDecision["ğŸ”„ Reload Decision<br/>Concierge Agent"]
    ReloadDecision -->|Significant Improvement| ReloadGraph["âš¡ Reload Optimized<br/>Tree from DB"]
    ReloadDecision -->|Minor Changes| ContinueProcessing["â¡ï¸ Continue with<br/>Current Version"]
    
    ReloadGraph --> Ready
    ContinueProcessing --> NextBatch
    
    %% Relationship & Context Specific Flows
    subgraph RelationshipFlow ["ğŸ¤ Relationship Processing Details"]
        direction LR
        R1["ğŸ“Š Calculate Interaction<br/>Frequency"] --> R2["ğŸ“ˆ Update Relationship<br/>Strength (0-1)"]
        R2 --> R3["ğŸ·ï¸ Classify Type<br/>friendly/professional/conflictual"]
        R3 --> R4["ğŸ“ Update Communication<br/>Patterns & History"]
        R4 --> R5["ğŸ’¬ Update Context Window<br/>Last 10 interactions"]
    end
    
    subgraph ContextFlow ["ğŸ’¬ Context Window Management"]
        direction LR
        C1["ğŸ“¥ Add New Message<br/>to Window"] --> C2["ğŸ“Š Update Emotional<br/>Trajectory"]
        C2 --> C3["ğŸ·ï¸ Refresh Topic<br/>Flow"] --> C4["ğŸ”„ Slide Window<br/>if > 10 messages"]
    end
    
    %% Performance Metrics
    subgraph Metrics ["ğŸ“Š Performance Targets"]
        direction TB
        M1[âš¡ Embedding: 50-100ms]
        M2[ğŸ˜Š Sentiment: 20-50ms]
        M3[ğŸ¤ Relationships: 10-30ms]
        M4[ğŸ” Topic Match: <10ms]
        M5[ğŸ“¦ Batch Total: <500ms]
    end
    
    %% Styling
    classDef startStyle fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#000
    classDef processStyle fill:#e1f5fe,stroke:#1976d2,stroke-width:2px,color:#000
    classDef decisionStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    classDef agentStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef storageStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    classDef contextStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000
    
    class Start,Ready startStyle
    class SimStart,EventStream,BatchReady,Validate,NoiseFilter,ContextRetrieval,Converge,GraphUpdate,ConvUpdate,RelGraphUpdate,IndexUpdate processStyle
    class AccumCheck,StorageDecision,TimeCheck,ReloadDecision decisionStyle
    class SpamDetect,EmojiProcess,EmbedGen,SentAnalysis,ToxicCheck,RelUpdate,TopicCreate,TopicAssign agentStyle
    class RedisStore,StorageRaft,DBStore,VersionStore,LoadGraph,EmptyGraph storageStyle
    class BGExtract,ChatGPTFilter,GraphOptimize,VersionCreate,VersionSignal,ReloadGraph contextStyle