graph TB
    %% External Data Source
    PJ[("ğŸ“ pineapple.json<br/>Data Source")]
    
    %% Infrastructure Layer
    subgraph Infrastructure ["ğŸ—ï¸ Infrastructure Layer"]
        Redis[("ğŸ”´ Redis<br/>Event Accumulation")]
        DB[("ğŸ˜ PostgreSQL<br/>Versioned Trees")]
    end
    
    %% Raft Layer (Data Access Controllers)
    subgraph RaftLayer ["âš¡ Raft Layer - Data Access Controllers"]
        AR["ğŸŒŠ Accumulator Raft<br/>ğŸ“ Stateless<br/>âœ… Redis Access<br/>âŒ DB Access"]
        SR["ğŸ’¾ Storage Raft<br/>ğŸ“ Stateless<br/>âŒ Redis Access<br/>âœ… DB Access"]
    end
    
    %% Orchestration Layer
    subgraph OrchestrationLayer ["ğŸ¯ Orchestration Layer"]
        CA["ğŸ­ Concierge Agent<br/>ğŸ§  Stateful (In-Memory)<br/>âŒ Redis Access<br/>âŒ DB Access*<br/>ğŸ“Š In-Memory Social Graph"]
    end
    
    %% Stateless Processing Agents
    subgraph AgentLayer ["ğŸ¤– Stateless Processing Agents"]
        direction TB
        SA["ğŸ˜Š Sentiment Agent<br/>ğŸ“ Stateless<br/>ğŸ” Context-Aware Analysis"]
        RA["ğŸ¤ Relationship Agent<br/>ğŸ“ Stateless<br/>ğŸ‘¥ User Dynamics"]
        EA["ğŸ“Š Embedding Agent<br/>ğŸ“ Stateless<br/>ğŸ”¤ Semantic Vectors"]
        SPA["ğŸš« Spam Agent<br/>ğŸ“ Stateless<br/>ğŸ›¡ï¸ Content Filter"]
        EMA["ğŸ˜€ Emoji Agent<br/>ğŸ“ Stateless<br/>ğŸ”„ Text Conversion"]
        TA["â˜ ï¸ Toxicity Agent<br/>ğŸ“ Stateless<br/>âš ï¸ Harm Detection"]
        LA["ğŸ§  LLM Agent<br/>ğŸ“ Stateless<br/>ğŸ“ Topic Generation"]
    end
    
    %% Background Processing
    subgraph BackgroundLayer ["ğŸ”„ Background Processing"]
        BG["ğŸ¯ Background Agent<br/>ğŸ“ Stateless<br/>âŒ Redis Access<br/>âŒ DB Access<br/>ğŸ“¤ Receives Tree via Events<br/>ğŸ¤– ChatGPT Optimization"]
    end
    
    %% Simulation Layer
    subgraph SimulationLayer ["ğŸ¬ Event Simulation"]
        ES["ğŸª Event Simulator<br/>ğŸ“ Stateless<br/>âŒ Redis Access<br/>âŒ DB Access"]
    end
    
    %% Data Flow Connections
    PJ -->|"ğŸ“¤ Stream Events"| ES
    ES -->|"ğŸ“¨ Message Events"| AR
    AR <-->|"ğŸ“¥ğŸ“¤ Accumulate/Threshold"| Redis
    AR -->|"ğŸ“¦ Batch Dump (100 msgs)"| CA
    
    %% Concierge Orchestration
    CA -->|"ğŸ”„ Parallel Processing"| SA
    CA -->|"ğŸ”„ Parallel Processing"| RA
    CA -->|"ğŸ”„ Parallel Processing"| EA
    CA -->|"ğŸ”„ Sequential Processing"| SPA
    CA -->|"ğŸ”„ Sequential Processing"| EMA
    CA -->|"ğŸ”„ Parallel Processing"| TA
    CA -->|"ğŸ”„ Topic Creation"| LA
    
    %% Agent Responses
    SA -->|"ğŸ˜Š Contextual Sentiment"| CA
    RA -->|"ğŸ¤ Relationship Updates"| CA
    EA -->|"ğŸ“Š Embeddings"| CA
    SPA -->|"ğŸš« Spam Flags"| CA
    EMA -->|"ğŸ“ Clean Text"| CA
    TA -->|"â˜ ï¸ Toxicity Scores"| CA
    LA -->|"ğŸ·ï¸ Topic Assignments"| CA
    
    %% Enhanced Event-Driven Storage Flow
    CA -->|"ğŸ’¾ Regular Messages"| SR
    CA -->|"ğŸ“¤ Storage Event + Tree Payload"| SR
    SR <-->|"ğŸ“Š Persist Data & Trees"| DB
    
    %% Event-Driven Background Optimization
    CA -->|"ğŸ“¤ Background Event + Tree Payload"| BG
    BG -->|"ğŸ“¤ Optimized Storage Event + Tree"| SR
    BG -.->|"ğŸ”” Version Update Signal"| CA
    CA <-->|"âš¡ Load Latest Tree (Startup)"| DB
    
    %% Styling
    classDef raftStyle fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef agentStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef orchestratorStyle fill:#fff3e0,stroke:#e65100,stroke-width:4px,color:#000
    classDef infraStyle fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef dataStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#000
    
    class AR,SR raftStyle
    class SA,RA,EA,SPA,EMA,TA,LA agentStyle
    class CA orchestratorStyle
    class Redis,DB infraStyle
    class ES,BG dataStyle
    
    %% Access Control Legend
    subgraph Legend ["ğŸ” Access Control Legend"]
        L1["âœ… Full Access"]
        L2["âŒ No Access"] 
        L3["ğŸ“ Stateless"]
        L4["ğŸ§  Stateful"]
        L5[" * DB access only at startup"]
    end
    
    class L1,L2,L3,L4,L5 dataStyle
